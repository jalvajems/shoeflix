<%- include("../../views/partials/user/header") %>
<style>
  /* Your existing styles remain unchanged */
  .edit-btn {
    background-color: #2481e4;
    border: none;
    color: white;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease-in-out, transform 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
  }

  .edit-btn:hover {
    background-color: #0056b3;
    transform: scale(1.05);
  }

  .edit-btn a {
    color: white;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    height: 100%;
    padding: 10px 20px;
  }

  .edit-btn a:hover {
    text-decoration: none;
  }

  .add-address {
    background-color: #28a770;
    border: none;
    color: white;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    margin-top: 10px;
  }

  .add-address:hover {
    background-color: #39b153db;
    transform: scale(1.05);
    text-decoration: none;
  }

  .add-address a {
    color: white;
    text-decoration: none;
    display: inline-block;
    width: 100%;
    height: 100%;
    padding: 12px 24px;
  }
</style>
<div class="container mt-5">
  <h2>Checkout</h2>
  <div class="row">
    <!-- Address Selection -->
    <div class="col-md-6">
      <h4>Customer Details</h4>
      <div class="card mb-3">
        <div class="card-body">
          <p><strong>Full Name:</strong> <%= user.name %></p>
          <p><strong>Phone Number:</strong> <%= user.phone || 'Not provided' %></p>
        </div>
      </div>

      <h4>Delivery Address</h4>
      <% if (addresses && addresses.address.length > 0) { %>
        <form id="checkoutForm" action="/checkout" method="POST">
          <% addresses.address.forEach((addr, index) => { %>
            <div class="card mb-3">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <input type="radio" name="addressId" value="<%= addr._id %>" <%= addr.isDefault ? 'checked' : '' %> required>
                    <strong><%= addr.name %></strong>
                    <%- addr.isDefault ? '<span class="text-muted">(Default)</span>' : '' %><br>
                    <%= addr.landMark %>, <%= addr.city %>, <%= addr.state %> - <%= addr.pincode %><br>
                    Phone: <%= addr.phone %>, Alt: <%= addr.altPhone %><br>
                    Type: <%= addr.addressType %>
                  </div>
                  <a href="/api/addresses/<%= addr._id %>/edit" class="edit-btn">Edit</a>
                </div>
              </div>
            </div>
          <% }); %>
          <a href="/checkout-address" class="add-address mb-3">Add New Address</a>

          <!-- Payment Method -->
          <h4>Payment Method</h4>
          <div class="form-check">
            <input type="radio" class="form-check-input" name="paymentMethod" value="COD" required>
            <label class="form-check-label">Cash on Delivery</label>
          </div>
          <div class="form-check">
            <input type="radio" class="form-check-input" name="paymentMethod" value="Razorpay" required>
            <label class="form-check-label">Pay with Razorpay</label>
          </div>
        </form>
      <% } else { %>
        <p>No addresses found. <a href="/checkout-address">Add an address</a> to proceed.</p>
      <% } %>
    </div>

    <!-- Order Summary -->
    <div class="col-md-6">
      <h4>Apply Coupon</h4>
      <div class="input-group mb-3">
        <input type="text" class="form-control" placeholder="Enter coupon code">
        <div class="input-group-append">
          <button class="btn btn-apply-coupon" type="button">Apply</button>
        </div>
      </div>
      <h4>Available Coupons</h4>
      <div class="card mb-3">
        <div class="card-body">
          <p>25% OFF (ALMOST) EVERYTHING! USE CODE: SUMMER SALE</p>
        </div>
      </div>
      <h4>Order Summary</h4>
      <% if (cart && cart.items.length > 0) { %>
        <% cart.items.forEach(item => { %>
          <div class="card mb-3">
            <div class="card-body">
              <h5><%= item.productId.productName %></h5>
              <p>Size: <%= item.size || 'N/A' %>, Quantity: <%= item.quantity %></p>
              <p>Price: ₹<%= item.price.toFixed(2) %></p>
              <% const itemGST = item.price * 0.18; %>
              <% const itemTotalWithGST = item.price + itemGST; %>
              <p>GST (18%): ₹<%= itemGST.toFixed(2) %></p>
              <p>GST-Inclusive Price: ₹<%= itemTotalWithGST.toFixed(2) %></p>
            </div>
          </div>
        <% }); %>
        <p><strong>Subtotal:</strong> ₹<%= totalPrice.toFixed(2) %></p>
        <p><strong>GST (18%):</strong> ₹<%= totalGST.toFixed(2) %></p>
        <p><strong>Shipping:</strong> Free delivery</p>
        <h5><strong>Total:</strong> ₹<%= finalAmount.toFixed(2) %></p>
        <button type="submit" form="checkoutForm" class="btn btn-place-order">Place Order</button>
      <% } else { %>
        <p>Your cart is empty.</p>
      <% } %>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="/js/checkout.js"></script>
<%- include("../../views/partials/user/footer") %>